#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dirent.h>
#include <fnmatch.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>

void processdir(const struct dirent *dir) {
     puts(dir->d_name);
}

int filter(const struct dirent *dir) {
     uid_t user;
     struct stat dirinfo;
     int len = strlen(dir->d_name) + 7; 
     char path[len];

     strcpy(path, "/proc/");
     strcat(path, dir->d_name);
     user = getuid();
     if (stat(path, &dirinfo) < 0) {
	  perror("processdir() ==> stat()");
	  exit(EXIT_FAILURE);
     }
     return !fnmatch("[1-9]*", dir->d_name, 0) && user == dirinfo.st_uid;
}

char* get_process_name_by_pid(const int pid) {
    char* name = (char*)calloc(1024,sizeof(char));
    if(name){
        sprintf(name, "/proc/%d/cmdline",pid);
        FILE* f = fopen(name,"r");
        if(f){
            size_t size;
            size = fread(name, sizeof(char), 1024, f);
            if(size>0){
                if('\n'==name[size-1])
                    name[size-1]='\0';
            }
            fclose(f);
        }
    }
    return name;
}

void print_name_and_pid() {
     struct dirent **namelist;
     int n;
     int y = 0;
     char choice[256];
     n = scandir("/proc", &namelist, filter, 0);
     if (n < 0) {
	  	perror("Not enough memory.");
     }

     printf("What would you like to do?\n1) Print list of currently running processes\n2) Search for a specific process name\n");
     scanf("%s", choice);
     if (strcmp(choice, "0") == 1) {
	printf("\n");
     	while(n--) {
		int x = atoi(namelist[n]->d_name);
		printf("%s: ", get_process_name_by_pid(x));
		processdir(namelist[n]);
		free(namelist[n]);
	}
	free(namelist);
 
     }
     else if (strcmp(choice, "1") == 1) {
	char term[256];
	printf("Enter process you would like to search for: ");
	scanf("%s", term);
	while(n--) {
		int x = atoi(namelist[n]->d_name);
		if (strcmp(term, get_process_name_by_pid(x)) == 0) {
			printf("\n%s is a currently running process\n", term);
			y = 1;
			free(namelist[n]);
			break;
		}
		free(namelist[n]);
	}
	free(namelist);
	if (y == 0) {
		printf("\n%s is not a currently running process\n", term);
	}
     }
     else {
	printf("Please enter a valid input\n\n");
	print_name_and_pid();
     }
     printf("\n\n");
}

int main() {
     
     char choice[256] = "5";
     while (strcmp(choice,"4") != 0) {
     	printf("Choose one of the following options:\n");
     	printf("1) Scan list of processes\n2) Scan memory\n3) Scan system call table\n4) Exit\n");
     	scanf("%s", choice);
     	if (strcmp(choice, "0") == 1) {
		printf("\n");
		print_name_and_pid();
	}
	else if (strcmp(choice, "1") == 1) {
		printf("You chose 2\n");
	}
	else if (strcmp(choice, "2") == 1) {
		printf("You chose 3\n");
	}
	else if (strcmp(choice, "3") == 1) {
		printf("Exiting...\n");
	}
	else {
		printf("Please enter a valid input\n\n");
	}
     }
     return 0;
}

